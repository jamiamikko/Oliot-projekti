package avoidance;

import lejos.hardware.Button;
import lejos.hardware.motor.Motor;
import lejos.hardware.port.SensorPort;
import lejos.hardware.sensor.EV3IRSensor;
import lejos.robotics.RangeFinderAdaptor;
import lejos.robotics.navigation.DifferentialPilot;
import lejos.robotics.objectdetection.FeatureListener;
import lejos.robotics.objectdetection.RangeFeatureDetector;
import lejos.utility.Delay;

public class ObstacleDetector {

	protected final static double NINETY_DEGREES = 90.0;
	protected final static double PILOT_SPEED = 50.0;
	protected final static int PILOT_ACCELERATION = 25;
	protected final static float MAX_DISTANCE = 100.0f;
	protected final static int INTERVAL = 500;
	protected final static double WHEEL_DIAMETER = 30.0f;
	protected final static double DISTANCE_BETWEEN_WHEELS = 170.0;

	public static void main(String[] args) {
		
		final DifferentialPilot pilot = new DifferentialPilot(WHEEL_DIAMETER, DISTANCE_BETWEEN_WHEELS, Motor.D, Motor.B);
		
		final EV3IRSensor infraredSensor = new EV3IRSensor(SensorPort.S2);

		configurePilot(pilot);
		configureInfraredSensor(infraredSensor, pilot);

		// wait for the sensor to be completely initialized and start the robot
		Delay.msDelay(5000);
		System.out.println("    Starting!");
		pilot.forward();
		Button.waitForAnyPress();
	}

	private static void configureInfraredSensor(final EV3IRSensor infraredSensor, final DifferentialPilot pilot) {
		final RangeFinderAdaptor rangeFinderAdaptor = new RangeFinderAdaptor(infraredSensor.getDistanceMode());
		
		final RangeFeatureDetector rangeFeatureDetector = new RangeFeatureDetector(rangeFinderAdaptor, MAX_DISTANCE,INTERVAL);
		
		final FeatureListener detectedObjectListener = new DetectedObjectListener(pilot);
		
		rangeFeatureDetector.addListener(detectedObjectListener);
	}

	private static void configurePilot(final DifferentialPilot pilot) {
		pilot.setAcceleration(PILOT_ACCELERATION);
		pilot.setRotateSpeed(PILOT_SPEED);
		pilot.setTravelSpeed(PILOT_SPEED);
	}
}
